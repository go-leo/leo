package grpc

import (
	"github.com/go-leo/leo/v3/cmd/protoc-gen-go-leo/gen/internal"
	"google.golang.org/protobuf/compiler/protogen"
	"strconv"
)

type Generator struct {
	Plugin   *protogen.Plugin
	File     *protogen.File
	Services []*internal.Service
}

func NewGenerator(plugin *protogen.Plugin, file *protogen.File) (*Generator, error) {
	services, err := internal.NewServices(file)
	if err != nil {
		return nil, err
	}
	return &Generator{Plugin: plugin, File: file, Services: services}, nil
}

func (f *Generator) Generate() error {
	// 没有定义服务，则不生成代码
	if len(f.Services) <= 0 {
		return nil
	}
	file := f.File
	filename := file.GeneratedFilenamePrefix + "_leo.grpc.pb.go"
	g := f.Plugin.NewGeneratedFile(filename, file.GoImportPath)
	g.P("// Code generated by protoc-gen-go-leo. DO NOT EDIT.")
	g.P()
	g.P("package ", file.GoPackageName)
	g.P()
	for _, service := range f.Services {
		if err := f.GenerateServiceService(service, g); err != nil {
			return err
		}
		if err := f.GenerateClientService(service, g); err != nil {
			return err
		}
		if err := f.GenerateServerTransports(service, g); err != nil {
			return err
		}
		if err := f.GenerateServerService(service, g); err != nil {
			return err
		}
		if err := f.GenerateClientTransports(service, g); err != nil {
			return err
		}
	}
	return nil
}

func (f *Generator) GenerateServiceService(service *internal.Service, g *protogen.GeneratedFile) error {
	g.P("func New", service.GrpcServerName(), "(svc ", service.ServiceName(), ", opts ...", internal.GrpcxTransportxPackage.Ident("ServerOption"), ") ", service.ServerName(), " {")
	g.P("options := ", internal.GrpcxTransportxPackage.Ident("NewServerOptions"), "(opts...)")
	g.P("endpoints := &", service.Unexported(service.ServerEndpointsName()), "{")
	g.P("svc:         svc,")
	g.P("middlewares: options.Middlewares(),")
	g.P("}")
	g.P("transports := &", service.Unexported(service.GrpcServerTransportsName()), "{")
	g.P("endpoints: endpoints,")
	g.P("}")
	g.P("return &", service.Unexported(service.GrpcServerName()), "{")
	for _, endpoint := range service.Endpoints {
		g.P(endpoint.Unexported(endpoint.Name()), ": transports.", endpoint.Name(), "(),")
	}
	g.P("}")
	g.P("}")
	g.P()
	return nil
}

func (f *Generator) GenerateClientService(service *internal.Service, g *protogen.GeneratedFile) error {
	g.P("func New", service.GrpcClientName(), "(target string, opts ...", internal.GrpcxTransportxPackage.Ident("ClientOption"), ") ", service.ServiceName(), " {")
	g.P("options := ", internal.GrpcxTransportxPackage.Ident("NewClientOptions"), "(opts...)")
	g.P("transports := &", service.Unexported(service.GrpcClientTransportsName()), "{")
	g.P("dialOptions:   options.DialOptions(),")
	g.P("clientOptions: options.ClientTransportOptions(),")
	g.P("middlewares:   options.Middlewares(),")
	g.P("}")
	g.P("factories := &", service.Unexported(service.FactoriesName()), "{")
	g.P("transports: transports,")
	g.P("}")
	g.P("endpointer := &", service.Unexported(service.EndpointersName()), "{")
	g.P("target:    target,")
	g.P("builder:   options.Builder(),")
	g.P("factories: factories,")
	g.P("logger:    options.Logger(),")
	g.P("options:   options.EndpointerOptions(),")
	g.P("}")
	g.P("balancers := &", service.Unexported(service.BalancersName()), "{")
	g.P("factory:    options.BalancerFactory(),")
	g.P("endpointer: endpointer,")
	g.P("}")
	g.P("endpoints := &", service.Unexported(service.ClientEndpointsName()), "{")
	g.P("balancers: balancers,")
	g.P("}")
	g.P("return &", service.Unexported(service.ClientServiceName()), "{")
	g.P("endpoints:     endpoints,")
	g.P("transportName: ", internal.GrpcxTransportxPackage.Ident("GrpcClient"), ",")
	g.P("}")
	g.P("}")
	g.P()
	return nil
}

func (f *Generator) GenerateServerTransports(service *internal.Service, g *protogen.GeneratedFile) error {
	g.P("type ", service.Unexported(service.GrpcServerTransportsName()), " struct {")
	g.P("endpoints ", service.ServerEndpointsName())
	g.P("}")
	g.P()
	for _, endpoint := range service.Endpoints {
		g.P("func (t *", service.Unexported(service.GrpcServerTransportsName()), ") ", endpoint.Name(), "() ", internal.GrpcTransportPackage.Ident("Handler"), "{")
		g.P("return ", internal.GrpcTransportPackage.Ident("NewServer"), "(")
		g.P("t.endpoints.", endpoint.Name(), "(", internal.TODO, "()), ")
		g.P("func(_ ", internal.Context, ", v any) (any, error) { return v, nil },")
		g.P("func(_ ", internal.Context, ", v any) (any, error) { return v, nil },")
		g.P(internal.GrpcTransportPackage.Ident("ServerBefore"), "(", internal.GrpcxTransportxPackage.Ident("ServerEndpointInjector"), "(", strconv.Quote(endpoint.FullName()), ")),")
		g.P(internal.GrpcTransportPackage.Ident("ServerBefore"), "(", internal.GrpcxTransportxPackage.Ident("ServerTransportInjector"), "),")
		g.P(internal.GrpcTransportPackage.Ident("ServerBefore"), "(", internal.MetadataxGrpcIncomingInjector, "),")
		g.P(internal.GrpcTransportPackage.Ident("ServerBefore"), "(", internal.StainxGrpcIncomingInjector, "),")
		g.P(")")
		g.P("}")
		g.P()
	}
	return nil
}

func (f *Generator) GenerateServerService(service *internal.Service, g *protogen.GeneratedFile) error {
	g.P("type ", service.Unexported(service.GrpcServerName()), " struct {")
	for _, endpoint := range service.Endpoints {
		g.P(endpoint.Unexported(endpoint.Name()), " ", internal.GrpcTransportPackage.Ident("Handler"))
	}
	g.P("}")
	g.P()
	for _, endpoint := range service.Endpoints {
		g.P("func (s *", service.Unexported(service.GrpcServerName()), ") ", endpoint.Name(), "(ctx ", internal.Context, ", request *", endpoint.InputGoIdent(), ") (*", endpoint.OutputGoIdent(), ", error){")
		g.P("ctx, rep, err := s.", endpoint.Unexported(endpoint.Name()), ".ServeGRPC(ctx, request)")
		g.P("if err != nil {")
		g.P("return nil, err")
		g.P("}")
		g.P("_ = ctx")
		g.P("return rep.(*", endpoint.OutputGoIdent(), "), nil")
		g.P("}")
		g.P()
	}
	g.P("func (s *", service.Unexported(service.GrpcServerName()), ") mustEmbedUnimplemented", service.ServerName(), "() {}")
	g.P()
	return nil
}

func (f *Generator) GenerateClientTransports(service *internal.Service, g *protogen.GeneratedFile) error {
	g.P("type ", service.Unexported(service.GrpcClientTransportsName()), " struct {")
	g.P("dialOptions []", internal.GrpcPackage.Ident("DialOption"))
	g.P("clientOptions []", internal.GrpcTransportPackage.Ident("ClientOption"))
	g.P("middlewares []", internal.EndpointPackage.Ident("Middleware"))
	g.P("}")
	g.P()
	for _, endpoint := range service.Endpoints {
		g.P("func (t *", service.Unexported(service.GrpcClientTransportsName()), ") ", endpoint.Name(), "(ctx ", internal.Context, ", instance string) (", internal.EndpointPackage.Ident("Endpoint"), ", ", internal.IOPackage.Ident("Closer"), ", error) {")
		g.P("conn, err := ", internal.GrpcPackage.Ident("NewClient"), "(instance, t.dialOptions...)")
		g.P("if err != nil {")
		g.P("return nil, nil, err")
		g.P("}")
		g.P("opts := []", internal.GrpcTransportPackage.Ident("ClientOption"), "{")
		g.P(internal.GrpcTransportPackage.Ident("ClientBefore"), "(", internal.MetadataxGrpcOutgoingInjector, "),")
		g.P(internal.GrpcTransportPackage.Ident("ClientBefore"), "(", internal.StainxGrpcOutgoingInjector, "),")
		g.P("}")
		g.P("opts = append(opts, t.clientOptions...)")
		g.P("client := ", internal.GrpcTransportPackage.Ident("NewClient"), "(")
		g.P("conn,")
		g.P(strconv.Quote(service.FullName()), ",")
		g.P(strconv.Quote(endpoint.Name()), ", ")
		g.P("func(_ ", internal.Context, ", v any) (any, error) { return v, nil }", ", ")
		g.P("func(_ ", internal.Context, ", v any) (any, error) { return v, nil }", ", ")
		g.P(endpoint.OutputGoIdent(), "{},")
		g.P("opts...)")
		g.P("return ", internal.EndpointxChain, "(client.Endpoint(), t.middlewares...), conn, nil")
		g.P("}")
		g.P()
	}
	return nil
}
